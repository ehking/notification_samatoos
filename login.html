<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" dir="rtl">
    <title>login</title>
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="node_modules/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/all.min.css">

</head>
<body>
<section class="link1" >
    <label >
        <div class="all-arrow">
            <a onclick="ipcRenderer.send('minimize')" class="an-arrow" style="float: left;margin-left: 5px;font-size: 22px"><i class="fa fa-window-minimize"></i></a>
        </div>
    </label>
</section>
<section class="link2" style="float: left">
    <label >
        <div class="all-arrow">
            <a onclick="app_exit()" class="an-arrow" style="float: left;margin-left: 5px;font-size: 22px"><i class="fa fa-times-circle"></i></a>
        </div>
    </label>
</section>
<div id="block">
    <div class="load-wrapp" style="display: none">
        <div class="load-2">
            <div class="line"></div>
            <div class="line"></div>
            <div class="line"></div>
            <p id="blinkp">درحال بارگزاری</p>
        </div>
    </div>


<div class="main-form">
    <i class="logo"> <img src="assets/img/logo.jpg" alt=""></i>
    <form action="" id="valid1" name="registration">
        <input type="text" placeholder="آدرس سایت" value="" name="url" id="url">
        <button class="button" onclick="nextAPI()">مرحله بعد</button>
    </form>

<div id="form2" >
    <form action="" id="valid2" name="registration"  style="display: none">
        <input type="text" placeholder="نام کاربری" value="" name="username" id="username">
        <input type="password" placeholder="گذرواژه" value="" name="password" id="password">
        <br/>
        <br/>
        <div id="show_capt" style="display: none">
            <p style="text-align: right;font-size: 13px;margin: 0">کد امنیتی را وارد کنید</p>
            <img src="" id="imgcaptcha" alt="" style="width: 100%">
            <input type="text" placeholder="کد امنیتی" value="" name="captcha" id="captcha">
            <!--</div>-->
        </div>

        <hr>
        <button class="button" onclick="callAPI()">وارد شوید</button>
    </form>
    <!--<div id="captcha_re" style="display: none">-->



</div>

</div>


</div>
<script type="application/javascript" src="node_modules/jquery/dist/jquery.min.js"></script>
<script type="application/javascript" src="node_modules/jquery-validation/dist/jquery.validate.min.js"></script>
<script type="application/javascript" src="assets/js/index.js"></script>
<script type="application/javascript">
    window.jQuery = window.$ = require('jquery');

        $(document).ready(function () {
           keytar.getPassword('config','orig_url').then(function (data) {
               keytar.getPassword('config','username').then(function (user) {
                   $('#username').val(user);
               })
               $('#url').val(data);
           })
        });

        function nextAPI() {
            url_Office = $('#url').val();
            keytar.setPassword('config','orig_url',url_Office);
            url_Office = url_Office.replace('UI/login.php', 'Runtime/process.php?');
            url_Office = url_Office.replace('UI/index.php', 'Runtime/process.php?');
            $('#valid1').validate({ // initialize the plugin
                rules: {
                    url: {
                        required: true,
                    },
                },
                messages: {
                    url: {
                        required: "آدرس سایت را وارد کنید",
                    },
                },
                success: "valid1",
                submitHandler: function () {
                    // console.log('ds')
                    cheek_captcha(url_Office);
                    // captchareload(url_Office);
                }
            });
        }
        function cheek_captcha(url_Offices) {
            // url_Office=url_Offices+'&module=Captcha&action=show&width=173&height=50';
            url_Office=url_Offices+'&module=Captcha&action=check';
            $.ajax({
                type : "GET",
                url : url_Office,
                timeout:8000,
                async:false,
                success: function (response) {
                    data = response.replace('(', '');
                    data = data.replace(')', '');
                    var parsed = JSON.parse(data);
                    if (parsed.success===true){
                        keytar.setPassword('captcha','en_di',"true");
                        captchareload(url_Offices);
                    }else{
                        setTimeout(function () {
                            $('#valid1').fadeOut(1000);
                            $('#valid2').fadeIn(2000);
                            $("#show_capt").fadeOut();
                            keytar.setPassword('url_Office','url_Office',url_Offices);
                            keytar.setPassword('captcha','en_di',"false");
                            hideloading();
                        },1000)
                    }
                },
                beforeSend: function(){
                    showloading()
                },
                statusCode: {
                    // 503: function() {
                    //     alert("Username already exist");
                    // }
                },
                error: function () {
                    // alert("url cheeked");
                    hideloading();
                    clearInterval();
                    swal({
                        buttons:{
                            ok:{
                                text:"تلاش دوباره",
                                confirmButtonColor:"#DD6B55",
                                className:"btnok"
                            },
                            close:{
                                text:"بازگشت",
                                className:"btncan"
                            }
                        },
                        icon:"error",
                        tittle:"خطا اتصال",
                        text:"ادرس وارد شده اشتباه و یا ارتباط شما با شبکه قطع میباشد"
                    }).then((value)=> {
                        switch (value) {
                            case "ok":
                                cheek_captcha(url_Offices);
                                break;
                            case "close":

                                break;
                            default:
                                cheek_captcha(url_Offices);
                                break;
                        }
                    });
                }
            });
        }
        function captchareload(url_Offices) {
            url_Office=url_Offices+'&module=Captcha&action=show&width=173&height=50';
            // url_Office=url_Offices+'&module=Captcha&action=check';
            $.ajax({
                type : "GET",
                url : url_Office,
                // data : JSON.stringify(data),
                timeout:5000,
                contentType: "application/json; charset=UTF-8",
                success: function (response) {
                    // console.log(url_Office);
                    setTimeout(function () {
                        console.log("d");
                        $('#imgcaptcha').attr('src',url_Office);
                        $('#valid1').fadeOut(1000);
                        $('#valid2').fadeIn(2000);
                        $('#show_capt').fadeIn(2000);
                        keytar.setPassword('url_Office','url_Office',url_Offices);
                        hideloading();
                    },1000)
                },
                beforeSend: function(){
                     showloading()
                },
                statusCode: {
                    // 503: function() {
                    //     alert("Username already exist");
                    // }
                },
                error: function () {
                    // alert("url cheeked");
                     hideloading();
                     clearInterval();
                    swal({
                        buttons:{
                            ok:{
                                text:"تلاش دوباره",
                                confirmButtonColor:"#DD6B55",
                                className:"btnok"
                            },
                            close:{
                                text:"بازگشت",
                                className:"btncan"
                            }
                        },
                        icon:"error",
                        tittle:"خطا اتصال",
                        text:"ادرس وارد شده اشتباه و یا ارتباط شما با شبکه قطع میباشد"
                    }).then((value)=> {
                       switch (value) {
                           case "ok":
                               cheek_captcha(url_Offices);
                               break;
                           case "close":

                               break;
                           default:
                               cheek_captcha(url_Offices);
                               break;
                       }
                    });
                }
            });
                 // $('#valid1').fadeOut(1000);
                 //  $('#form2').fadeIn(2000);
        }

    function callAPI() {
            // showloading();
                $('#valid2').validate({ // initialize the plugin
                    rules: {
                        captcha: {
                            required: true,
                        },
                        username: {
                            required: true,
                        },
                        password: {
                            required: false
                        }
                    },
                    messages: {
                        username: {
                            required: "نام کاربری خود را وارد کنید"
                        },
                        password: {
                            required: "گذرواژه خود را وارد کتید"
                        },
                        captcha: {
                            required: "کد امنیتی خود را وارد کتید"
                        }
                    },
                    success: "valid2",
                    submitHandler: function () {
                        showloading();
                        // url_Office = url_Office.replace('UI/login.php', 'Runtime/process.php?');
                        // url_Office = url_Office.replace('UI/index.php', 'Runtime/process.php?');
                        var usern = $('#username').val();
                        keytar.setPassword('config','username',usern);
                        var passwd = $('#password').val();
                         keytar.getPassword('captcha','en_di').then(function (data) {
                             if (data==="true")
                                 capt=$('#captcha').val();
                             else
                                  capt=false;

                             keytar.getPassword('url_Office','url_Office').then(function (data) {
                                 AjaxService(data,usern,passwd,capt);
                             });
                         });
                    }
                });
    }
</script>
</body>
</html>